# EMERALD
## Описание сервиса
Сервис-балансировщик пользовательских запросов,  
который отправляет пользователя с помощью 301-го HTTP редиректа смотреть видео либо на корневые сервера,  
либо отправлять его в CDN по определённым правилам.  
Счетчик переходов реализован через redis

## Запуск проекта
1. скопировать и переименовать `.example.env` в `.env`
2. выполнить`docker-compose up` - запускает проект, используя переменные в `.env`, после запуска, приложение доступно на 0.0.0.0:5000

Точка запуска приложения см. в `run.sh` там проверяется что redis доступен и запускается приложение с 9 воркерами по формуле:  
`4 ядра процессора * 2 + 1` (для ноутбука с процессором i5)

## Тесты
выполнить `pytest`

## Описание переменных
DEBUG=False - режим запуска приложения  
APP_HOST=0.0.0.0 - хост на котором запускать приложение  
APP_PORT=5000 - порт приложение  
REDIS_HOST=redis - хост redis  
REDIS_PORT=6379 - порт redis  
REDIS_DATABASE=0 - дефолтная 0 бд redis  
CDN_HOST=cdn-host.com - хост cdn на который нужно редиректить  
COUNTER_KEY=counter - ключ под которым в redis хранится счетчик переходов    

## Остальное
В качестве линтеров и форматтеров используются `black, isort, flake8`,  
их работа выполняется при `git commit` c помощью пакета `pre-commit`,   
для того чтобы выполнить прогон без commit, необходимо выполнить `pre-commit run -a`

Зависимости проекта управляются через `pipenv`

Тесты нагрузки можно выполнить после запуска проекта с помощью утилиты [wrk](https://github.com/wg/wrk)
`wrk -t4 -c1000 -d30s  http://0.0.0.0:5000/\?video\=http://s1.origin-cluster/video/1488/xcg2djHckad.m3u8   ` 